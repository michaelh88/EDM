<?php defined('SYSPATH') OR die('No direct script access.'); ?>

2016-12-16 09:00:15 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5395] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:00:21 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5396] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:00:25 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5397] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:00:28 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5398] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:00:34 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5399] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:00:42 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5400] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:00:46 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5401] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:01:24 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5402] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:01:28 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5403] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:01:31 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5404] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:01:33 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5405] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:01:55 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5406] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:02:12 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5407] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:02:21 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5408] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:03:13 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5409] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:03:17 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5410] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:03:24 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5411] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:03:28 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5412] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:03:31 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5413] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 09:03:40 --- INFO: [Utilisateur : sssambitsara] [Action : Création du lot 5414] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 13:59:53 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5415] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:00:18 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5416] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:01:19 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5417] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:01:31 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5418] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:01:36 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5419] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:01:53 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5420] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:02:22 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5421] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:02:31 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5422] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 14:02:39 --- INFO: [Utilisateur : ssvatosoa] [Action : Création du lot 5423] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:10:16 --- EMERGENCY: Database_Exception [ 2013 ]: Lost connection to MySQL server during query [ SELECT
								lot.lot_id,
								nombre_doc,
								datetime_creation,
								commande_vivetic,
								nom_zip,
								nom_zip_original,
								createur_lot,
								datetime_modification,
								modificateur_lot,
								datetime_validation,
								nom_projet,
								projet_id,
								avancement_globale,
								CASE WHEN volume_piece = 0 THEN nombre_doc ELSE volume_piece END AS volume_piece,
								nom_zip_temp,
								duree_traitement,
								termine_id,
								lot.termine,
								etat,
								nb_notif,
								nb_total_lot,
								nb_notif notif
							FROM
							(
								SELECT
									lot_final.lot_id,
									lot_final.nombre_doc,
									lot_final.datetime_creation,
									lot_final.commande_vivetic,
									lot_final.nom_zip,
									lot_final.nom_zip_original,
									lot_final.createur createur_lot,
									lot_final.datetime_modification,
									lot_final.modificateur modificateur_lot,
									lot_final.datetime_validation,
									lot_final.nom_projet,
									lot_final.projet_id,
									lot_final.avancement_globale,
									lot_final.nom_zip_temp,
									lot_final.duree_traitement,
									lot_final.termine_id,
									lot_final.termine,
									t4.nb_notif,
									t4.nb_total_lot,
									t4.nb_notif notif
								FROM
									(SELECT
										l.lot_id lot_id,
										nombre_doc,
										l.datetime_creation datetime_creation,
										commande_vivetic,
										nom_zip,
										nom_zip_original,
										createur,
										datetime_modification,
										modificateur,
										datetime_validation,
										p.nom_projet nom_projet,
										p.projet_id projet_id,
										avancement_globale,
										nom_zip_temp,
										CASE
											WHEN termine = 1 THEN SEC_TO_TIME(TIMESTAMPDIFF(SECOND,
																l.datetime_creation,
																datetime_debut_max))
											WHEN termine = 0 THEN SEC_TO_TIME(TIMESTAMPDIFF(SECOND,
																l.datetime_creation,
																now()))
										END AS duree_traitement,

										termine termine_id,
										CASE
											WHEN termine = 0 THEN "Non Terminé"
											ELSE "Terminé"
										END as termine
									FROM
										(
											SELECT
												lot1.*, u.username modificateur
											FROM
												(
													SELECT
														l.*, u.username createur
													FROM
														(SELECT
															*
														FROM
															lot) l
													LEFT JOIN
														(SELECT
															id, username
														FROM
															users) u
													ON l.createur_lot = u.id
												)  lot1
											LEFT JOIN
												(SELECT
													id, username
												FROM
													users
												) u
											ON lot1.modificateur_lot = u.id
										) l
									LEFT JOIN
										(
											SELECT
												l.lot_id,
												ROUND(t1.volume_doc / (t2.nombre_doc*t2.nb_etape),
												2) as avancement_globale,
												t3.delai,
												t3.datetime_debut_max
											FROM
												lot l,
												(SELECT
													lot_id,
													SUM(volume_doc) volume_doc
												FROM
													(SELECT
														hl2.lot_id,

														hl2.volume_doc*100 as volume_doc,
														ep.etape_id
													FROM
														(
														SELECT
															*
														FROM
															historique_lot
														WHERE historique_lot_id IN	(
																			SELECT 	
																				MAX(historique_lot_id)
																			FROM 
																				historique_lot
																			GROUP BY lot_id, etape_projet_id
																		)
														) hl2,
														etape_projet ep,
														lot l
													WHERE
														ep.etape_projet_id = hl2.etape_projet_id
														AND ep.projet_id = l.projet_id
													GROUP BY
														hl2.lot_id,
														ep.etape_id) t
												GROUP BY lot_id
												) t1,
												(SELECT
													COUNT(*) nb_etape,
													lot_id,
													nombre_doc
												FROM
													etape_projet,
													lot
												WHERE
													etape_projet.projet_id = lot.projet_id
													AND lot.lot_id in (
																		SELECT
																			lot_id
																		FROM
																			lot   )
												GROUP BY lot.lot_id
												) t2,
												(SELECT
													lot_id,
													max(datetime_debut_max) as datetime_debut_max,
													max(t.delai)*60 as delai
												FROM
													(SELECT
														hl.lot_id,
														ep.delai,
														ep.ordre,
														MAX(hl.datetime_debut) datetime_debut_max,
														MAX(hl.datetime_fin) datetime_fin_max
													FROM
														etape_projet ep,
														historique_lot hl
													WHERE
														hl.etape_projet_id = ep.etape_projet_id
													GROUP BY
														ep.etape_id, hl.lot_id
													ORDER BY
														hl.lot_id, ep.ordre
													) t
												GROUP BY t.lot_id
												) t3
											WHERE
												t1.lot_id = t2.lot_id
												AND t1.lot_id = t3.lot_id
												AND                          t1.lot_id = l.lot_id
											GROUP BY t1.lot_id
										) req
									ON l.lot_id = req.lot_id
									INNER JOIN
										projet p
									ON l.projet_id = p.projet_id
									) lot_final
								LEFT JOIN
									(
										SELECT
											mes5.lot_id, mes5.nb_notif,
											CASE
												WHEN nb_total IS NULL THEN 0
												ELSE nb_total
											END as nb_total_lot
										FROM
										(
											SELECT
												l.lot_id,
												CASE
													WHEN nb IS NULL THEN 0
													ELSE nb
												END as nb_notif
											FROM
												lot l
											LEFT JOIN
												(
													SELECT
														lot_id,
														COUNT(*) AS nb
													FROM
														message
													INNER JOIN
														message_user
															ON message.message_id = message_user.message_id
													WHERE
														datetime_lecture IS NULL
														AND message_user.user_id=  20
													GROUP BY
														lot_id
												) t_nb
													ON l.lot_id =t_nb.lot_id
											) mes5
										LEFT JOIN
											(
												SELECT
													lot_id,
													COUNT(*) AS nb_total
												FROM
													message
												INNER JOIN
													message_user
														ON message.message_id = message_user.message_id
												WHERE
													message_user.user_id=   20
												GROUP BY
													lot_id
											) mes6
										ON mes5.lot_id = mes6.lot_id
									)   t4
								ON lot_final.lot_id = t4.lot_id
							) lot
							LEFT JOIN
							(
								SELECT
									lot_id,
									termine ,
									CASE
										WHEN termine = 1 THEN "Terminé"
										WHEN (SELECT LOCATE( "Alerte", statut )) > 0 THEN "Alerte délai"
										WHEN (SELECT LOCATE( "Alerte", statut )) = 0 AND debut is not null THEN "En cours"
										WHEN (SELECT LOCATE( "Alerte", statut )) = 0 AND debut is null THEN "Créé"
										ELSE "En cours"
									END AS etat
								FROM
								(
									SELECT
										lot_id,
										datetime_creation,
										projet_id,
										nom_zip,
										termine ,
										MIN(compare_fin) compare_fin,
										GROUP_CONCAT( statut SEPARATOR "," ) statut
										,MIN(debut) debut
									FROM
									(
										SELECT
											lot_id,
											datetime_creation,
											projet_id,
											nom_zip,
											termine ,
											etape_projet_id,
											etape_id,
											delai,
											deadline_etape,
											compare_fin,
											CASE 	WHEN compare_fin < now() THEN "OK"
													WHEN compare_fin >= now() AND TIME_TO_SEC(TIMEDIFF(deadline_etape,compare_fin)) < 0 THEN "Alerte"
													ELSE "OK" END statut
											,debut
										FROM
										(
										
										
										
										
											SELECT
														ddl.lot_id,
														datetime_creation,
														projet_id,
														nom_zip,
														termine ,
														ddl.etape_projet_id,
														etape_id,
														delai,
														deadline_etape,
														CASE WHEN fin IS NULL THEN NOW() ELSE fin END compare_fin
														,hl.debut
											FROM
											(
												SELECT
														lot_id,
														datetime_creation,
														projet_id,
														nom_zip,
														termine ,
														dl.etape_projet_id,
														etape_id,
														delai,
													ADDDATE(datetime_creation , INTERVAL delai HOUR) deadline_etape
												FROM
												(
													SELECT
														l.lot_id,
														l.datetime_creation,
														l.projet_id,
														l.nom_zip,
														l.termine ,
														ep.etape_projet_id,
														ep.etape_id,
														ep.delai
													FROM
														lot l
														INNER JOIN etape_projet ep
															ON l.projet_id = ep.projet_id
													#WHERE l.projet_id = 1
													ORDER BY l.lot_id , ep.etape_id
												)dl
											) ddl
											LEFT JOIN (
												SELECT
													lot_id,
													etape_projet_id,
													CASE WHEN MAX(datetime_fin) IS NULL THEN NOW() ELSE MAX(datetime_fin) END fin
													,CASE WHEN MAX(datetime_debut) IS NULL THEN NOW() ELSE MAX(datetime_debut) END debut
												FROM
													historique_lot
												GROUP BY
													lot_id,
													etape_projet_id

											) hl
											ON ddl.lot_id = hl.lot_id AND ddl.etape_projet_id = hl.etape_projet_id
											
											
											
											
										) tba
									) tab2
									GROUP BY lot_id
								) final_etat
							) etat_final
							ON lot.lot_id = etat_final.lot_id
							LEFT JOIN
							(
								SELECT 
									lot.lot_id,CASE WHEN table2.volume_piece IS NULL THEN 0 ELSE  table2.volume_piece END volume_piece
								FROM 
									lot
								LEFT JOIN 
								(
									  SELECT
										historique_lot.lot_id,historique_lot.volume_piece,table1.libelle
									  FROM
										historique_lot
									  JOIN
										(
											SELECT 
												max(historique_lot_id) historique_lot_id,etape.defaut,etape_projet.ordre,etape.libelle
											FROM 
												historique_lot,etape_projet,etape
											WHERE historique_lot.etape_projet_id = etape_projet.etape_projet_id  AND etape.etape_id = etape_projet.etape_id AND etape.defaut = 0
											GROUP BY historique_lot.etape_projet_id,lot_id
											ORDER BY lot_id,historique_lot.etape_projet_id,etape_projet.ordre
										) table1
									  ON 
										historique_lot.historique_lot_id = table1.historique_lot_id
									  GROUP BY historique_lot.lot_id
								) table2
								ON
								 lot.lot_id = table2.lot_id
							) table3
							ON lot.lot_id = table3.lot_id
							WHERE 1=1  AND projet_id IN (10) AND termine_id IN (0,1)ORDER BY  lot_id asc LIMIT 0,144 ] ~ MODPATH/mysqli/classes/Database/MySQLi.php [ 177 ] in /home/fthmgedcbc/www/modules/database/classes/Kohana/Database/Query.php:251
2016-12-16 18:10:16 --- DEBUG: #0 /home/fthmgedcbc/www/modules/database/classes/Kohana/Database/Query.php(251): Database_MySQLi->query(1, 'SELECT\r\n\t\t\t\t\t\t\t...', false, Array)
#1 /home/fthmgedcbc/www/application/classes/Controller/Lot.php(665): Kohana_Database_Query->execute()
#2 /home/fthmgedcbc/www/system/classes/Kohana/Controller.php(84): Controller_Lot->action_ajax_browse()
#3 [internal function]: Kohana_Controller->execute()
#4 /home/fthmgedcbc/www/system/classes/Kohana/Request/Client/Internal.php(97): ReflectionMethod->invoke(Object(Controller_Lot))
#5 /home/fthmgedcbc/www/system/classes/Kohana/Request/Client.php(114): Kohana_Request_Client_Internal->execute_request(Object(Request), Object(Response))
#6 /home/fthmgedcbc/www/system/classes/Kohana/Request.php(997): Kohana_Request_Client->execute(Object(Request))
#7 /home/fthmgedcbc/www/index.php(120): Kohana_Request->execute()
#8 {main} in /home/fthmgedcbc/www/modules/database/classes/Kohana/Database/Query.php:251
2016-12-16 18:11:57 --- EMERGENCY: Database_Exception [ 2013 ]: Lost connection to MySQL server during query [ SELECT
								lot.lot_id,
								nombre_doc,
								datetime_creation,
								commande_vivetic,
								nom_zip,
								nom_zip_original,
								createur_lot,
								datetime_modification,
								modificateur_lot,
								datetime_validation,
								nom_projet,
								projet_id,
								avancement_globale,
								CASE WHEN volume_piece = 0 THEN nombre_doc ELSE volume_piece END AS volume_piece,
								nom_zip_temp,
								duree_traitement,
								termine_id,
								lot.termine,
								etat,
								nb_notif,
								nb_total_lot,
								nb_notif notif
							FROM
							(
								SELECT
									lot_final.lot_id,
									lot_final.nombre_doc,
									lot_final.datetime_creation,
									lot_final.commande_vivetic,
									lot_final.nom_zip,
									lot_final.nom_zip_original,
									lot_final.createur createur_lot,
									lot_final.datetime_modification,
									lot_final.modificateur modificateur_lot,
									lot_final.datetime_validation,
									lot_final.nom_projet,
									lot_final.projet_id,
									lot_final.avancement_globale,
									lot_final.nom_zip_temp,
									lot_final.duree_traitement,
									lot_final.termine_id,
									lot_final.termine,
									t4.nb_notif,
									t4.nb_total_lot,
									t4.nb_notif notif
								FROM
									(SELECT
										l.lot_id lot_id,
										nombre_doc,
										l.datetime_creation datetime_creation,
										commande_vivetic,
										nom_zip,
										nom_zip_original,
										createur,
										datetime_modification,
										modificateur,
										datetime_validation,
										p.nom_projet nom_projet,
										p.projet_id projet_id,
										avancement_globale,
										nom_zip_temp,
										CASE
											WHEN termine = 1 THEN SEC_TO_TIME(TIMESTAMPDIFF(SECOND,
																l.datetime_creation,
																datetime_debut_max))
											WHEN termine = 0 THEN SEC_TO_TIME(TIMESTAMPDIFF(SECOND,
																l.datetime_creation,
																now()))
										END AS duree_traitement,

										termine termine_id,
										CASE
											WHEN termine = 0 THEN "Non Terminé"
											ELSE "Terminé"
										END as termine
									FROM
										(
											SELECT
												lot1.*, u.username modificateur
											FROM
												(
													SELECT
														l.*, u.username createur
													FROM
														(SELECT
															*
														FROM
															lot) l
													LEFT JOIN
														(SELECT
															id, username
														FROM
															users) u
													ON l.createur_lot = u.id
												)  lot1
											LEFT JOIN
												(SELECT
													id, username
												FROM
													users
												) u
											ON lot1.modificateur_lot = u.id
										) l
									LEFT JOIN
										(
											SELECT
												l.lot_id,
												ROUND(t1.volume_doc / (t2.nombre_doc*t2.nb_etape),
												2) as avancement_globale,
												t3.delai,
												t3.datetime_debut_max
											FROM
												lot l,
												(SELECT
													lot_id,
													SUM(volume_doc) volume_doc
												FROM
													(SELECT
														hl2.lot_id,

														hl2.volume_doc*100 as volume_doc,
														ep.etape_id
													FROM
														(
														SELECT
															*
														FROM
															historique_lot
														WHERE historique_lot_id IN	(
																			SELECT 	
																				MAX(historique_lot_id)
																			FROM 
																				historique_lot
																			GROUP BY lot_id, etape_projet_id
																		)
														) hl2,
														etape_projet ep,
														lot l
													WHERE
														ep.etape_projet_id = hl2.etape_projet_id
														AND ep.projet_id = l.projet_id
													GROUP BY
														hl2.lot_id,
														ep.etape_id) t
												GROUP BY lot_id
												) t1,
												(SELECT
													COUNT(*) nb_etape,
													lot_id,
													nombre_doc
												FROM
													etape_projet,
													lot
												WHERE
													etape_projet.projet_id = lot.projet_id
													AND lot.lot_id in (
																		SELECT
																			lot_id
																		FROM
																			lot   )
												GROUP BY lot.lot_id
												) t2,
												(SELECT
													lot_id,
													max(datetime_debut_max) as datetime_debut_max,
													max(t.delai)*60 as delai
												FROM
													(SELECT
														hl.lot_id,
														ep.delai,
														ep.ordre,
														MAX(hl.datetime_debut) datetime_debut_max,
														MAX(hl.datetime_fin) datetime_fin_max
													FROM
														etape_projet ep,
														historique_lot hl
													WHERE
														hl.etape_projet_id = ep.etape_projet_id
													GROUP BY
														ep.etape_id, hl.lot_id
													ORDER BY
														hl.lot_id, ep.ordre
													) t
												GROUP BY t.lot_id
												) t3
											WHERE
												t1.lot_id = t2.lot_id
												AND t1.lot_id = t3.lot_id
												AND                          t1.lot_id = l.lot_id
											GROUP BY t1.lot_id
										) req
									ON l.lot_id = req.lot_id
									INNER JOIN
										projet p
									ON l.projet_id = p.projet_id
									) lot_final
								LEFT JOIN
									(
										SELECT
											mes5.lot_id, mes5.nb_notif,
											CASE
												WHEN nb_total IS NULL THEN 0
												ELSE nb_total
											END as nb_total_lot
										FROM
										(
											SELECT
												l.lot_id,
												CASE
													WHEN nb IS NULL THEN 0
													ELSE nb
												END as nb_notif
											FROM
												lot l
											LEFT JOIN
												(
													SELECT
														lot_id,
														COUNT(*) AS nb
													FROM
														message
													INNER JOIN
														message_user
															ON message.message_id = message_user.message_id
													WHERE
														datetime_lecture IS NULL
														AND message_user.user_id=  20
													GROUP BY
														lot_id
												) t_nb
													ON l.lot_id =t_nb.lot_id
											) mes5
										LEFT JOIN
											(
												SELECT
													lot_id,
													COUNT(*) AS nb_total
												FROM
													message
												INNER JOIN
													message_user
														ON message.message_id = message_user.message_id
												WHERE
													message_user.user_id=   20
												GROUP BY
													lot_id
											) mes6
										ON mes5.lot_id = mes6.lot_id
									)   t4
								ON lot_final.lot_id = t4.lot_id
							) lot
							LEFT JOIN
							(
								SELECT
									lot_id,
									termine ,
									CASE
										WHEN termine = 1 THEN "Terminé"
										WHEN (SELECT LOCATE( "Alerte", statut )) > 0 THEN "Alerte délai"
										WHEN (SELECT LOCATE( "Alerte", statut )) = 0 AND debut is not null THEN "En cours"
										WHEN (SELECT LOCATE( "Alerte", statut )) = 0 AND debut is null THEN "Créé"
										ELSE "En cours"
									END AS etat
								FROM
								(
									SELECT
										lot_id,
										datetime_creation,
										projet_id,
										nom_zip,
										termine ,
										MIN(compare_fin) compare_fin,
										GROUP_CONCAT( statut SEPARATOR "," ) statut
										,MIN(debut) debut
									FROM
									(
										SELECT
											lot_id,
											datetime_creation,
											projet_id,
											nom_zip,
											termine ,
											etape_projet_id,
											etape_id,
											delai,
											deadline_etape,
											compare_fin,
											CASE 	WHEN compare_fin < now() THEN "OK"
													WHEN compare_fin >= now() AND TIME_TO_SEC(TIMEDIFF(deadline_etape,compare_fin)) < 0 THEN "Alerte"
													ELSE "OK" END statut
											,debut
										FROM
										(
										
										
										
										
											SELECT
														ddl.lot_id,
														datetime_creation,
														projet_id,
														nom_zip,
														termine ,
														ddl.etape_projet_id,
														etape_id,
														delai,
														deadline_etape,
														CASE WHEN fin IS NULL THEN NOW() ELSE fin END compare_fin
														,hl.debut
											FROM
											(
												SELECT
														lot_id,
														datetime_creation,
														projet_id,
														nom_zip,
														termine ,
														dl.etape_projet_id,
														etape_id,
														delai,
													ADDDATE(datetime_creation , INTERVAL delai HOUR) deadline_etape
												FROM
												(
													SELECT
														l.lot_id,
														l.datetime_creation,
														l.projet_id,
														l.nom_zip,
														l.termine ,
														ep.etape_projet_id,
														ep.etape_id,
														ep.delai
													FROM
														lot l
														INNER JOIN etape_projet ep
															ON l.projet_id = ep.projet_id
													#WHERE l.projet_id = 1
													ORDER BY l.lot_id , ep.etape_id
												)dl
											) ddl
											LEFT JOIN (
												SELECT
													lot_id,
													etape_projet_id,
													CASE WHEN MAX(datetime_fin) IS NULL THEN NOW() ELSE MAX(datetime_fin) END fin
													,CASE WHEN MAX(datetime_debut) IS NULL THEN NOW() ELSE MAX(datetime_debut) END debut
												FROM
													historique_lot
												GROUP BY
													lot_id,
													etape_projet_id

											) hl
											ON ddl.lot_id = hl.lot_id AND ddl.etape_projet_id = hl.etape_projet_id
											
											
											
											
										) tba
									) tab2
									GROUP BY lot_id
								) final_etat
							) etat_final
							ON lot.lot_id = etat_final.lot_id
							LEFT JOIN
							(
								SELECT 
									lot.lot_id,CASE WHEN table2.volume_piece IS NULL THEN 0 ELSE  table2.volume_piece END volume_piece
								FROM 
									lot
								LEFT JOIN 
								(
									  SELECT
										historique_lot.lot_id,historique_lot.volume_piece,table1.libelle
									  FROM
										historique_lot
									  JOIN
										(
											SELECT 
												max(historique_lot_id) historique_lot_id,etape.defaut,etape_projet.ordre,etape.libelle
											FROM 
												historique_lot,etape_projet,etape
											WHERE historique_lot.etape_projet_id = etape_projet.etape_projet_id  AND etape.etape_id = etape_projet.etape_id AND etape.defaut = 0
											GROUP BY historique_lot.etape_projet_id,lot_id
											ORDER BY lot_id,historique_lot.etape_projet_id,etape_projet.ordre
										) table1
									  ON 
										historique_lot.historique_lot_id = table1.historique_lot_id
									  GROUP BY historique_lot.lot_id
								) table2
								ON
								 lot.lot_id = table2.lot_id
							) table3
							ON lot.lot_id = table3.lot_id
							WHERE 1=1  AND projet_id IN (10) AND termine_id IN (0,1)ORDER BY  lot_id asc LIMIT 0,144 ] ~ MODPATH/mysqli/classes/Database/MySQLi.php [ 177 ] in /home/fthmgedcbc/www/modules/database/classes/Kohana/Database/Query.php:251
2016-12-16 18:11:57 --- DEBUG: #0 /home/fthmgedcbc/www/modules/database/classes/Kohana/Database/Query.php(251): Database_MySQLi->query(1, 'SELECT\r\n\t\t\t\t\t\t\t...', false, Array)
#1 /home/fthmgedcbc/www/application/classes/Controller/Lot.php(665): Kohana_Database_Query->execute()
#2 /home/fthmgedcbc/www/system/classes/Kohana/Controller.php(84): Controller_Lot->action_ajax_browse()
#3 [internal function]: Kohana_Controller->execute()
#4 /home/fthmgedcbc/www/system/classes/Kohana/Request/Client/Internal.php(97): ReflectionMethod->invoke(Object(Controller_Lot))
#5 /home/fthmgedcbc/www/system/classes/Kohana/Request/Client.php(114): Kohana_Request_Client_Internal->execute_request(Object(Request), Object(Response))
#6 /home/fthmgedcbc/www/system/classes/Kohana/Request.php(997): Kohana_Request_Client->execute(Object(Request))
#7 /home/fthmgedcbc/www/index.php(120): Kohana_Request->execute()
#8 {main} in /home/fthmgedcbc/www/modules/database/classes/Kohana/Database/Query.php:251
2016-12-16 18:13:23 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5424] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:26 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5425] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:29 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5426] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:35 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5427] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:41 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5428] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:45 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5429] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:50 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5430] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:53 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5431] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:57 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5432] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:13:58 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5433] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:02 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5434] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:05 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5435] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:08 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5436] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:10 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5437] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:14 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5438] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:16 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5439] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:19 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5440] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:23 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5441] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:25 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5442] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:29 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5443] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:31 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5444] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:35 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5445] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:38 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5446] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:42 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5447] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:47 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5448] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:50 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5449] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:54 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5450] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:14:57 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5451] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:04 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5452] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:06 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5453] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:09 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5454] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:10 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5455] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:13 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5456] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:16 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5457] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:19 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5458] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:23 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5459] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:27 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5460] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:29 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5461] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:32 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5462] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:37 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5463] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:39 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5464] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:43 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5465] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:46 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5466] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:50 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5467] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:15:53 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5468] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:04 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5469] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:06 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5470] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:09 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5471] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:13 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5472] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:16 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5473] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:20 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5474] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:24 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5475] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:29 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5476] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:33 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5477] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:37 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5478] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:39 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5479] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:42 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5480] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:45 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5481] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:46 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5482] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:50 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5483] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:54 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5484] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:16:57 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5485] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:01 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5486] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:02 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5487] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:07 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5488] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:09 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5489] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:13 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5490] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:17 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5491] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:20 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5492] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:23 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5493] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:26 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5494] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:28 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5495] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:32 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5496] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:36 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5497] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:39 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5498] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:42 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5499] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:46 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5500] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:49 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5501] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:53 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5502] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:17:57 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5503] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:01 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5504] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:06 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5505] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:10 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5506] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:12 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5507] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:14 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5508] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:22 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5509] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:26 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5510] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:29 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5511] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:34 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5512] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:35 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5513] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:39 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5514] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:44 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5515] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:45 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5516] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:49 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5517] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:53 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5518] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:18:54 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5519] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:19:00 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5520] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:19:04 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5521] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:19:06 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5522] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:19:10 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5523] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:19:11 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5524] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:19:17 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5525] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84
2016-12-16 18:19:19 --- INFO: [Utilisateur : svaratraza] [Action : Création du lot 5526] in /home/fthmgedcbc/www/system/classes/Kohana/Controller.php:84